!function(e){e.fn.entityForm=function(t){function a(){var t={};return i.find("input[type=file]").each(function(){var a,i=e(this),r=i.data("multiple"),n=i.attr("name"),p=i.closest(".form-group"),d=JSON.parse(p.find("script[data-upload-params]").html()).type;if("image"==d)if(r){var u=[];p.find("figure.image-upload-preview").each(function(){u.push({path:e(this).data("path")})}),a=u}else a={path:p.find("figure.image-upload-preview").eq(0).data("path")};else if("file"==d)if(r)u=[],p.find(".file-upload-preview").each(function(){var t=e(this);u.push({path:t.data("path"),file_type:t.data("file-type"),original_name:t.find(".title").text()})}),a=u;else{var l=p.find(".file-upload-preview").eq(0);a={path:l.data("path"),file_type:l.data("file-type"),original_name:l.find(".title").text()}}t[n]=a}),t=decodeURIComponent(e.param(t))}if(t.url){var i=e(this),r=e("#upload-preview-template").html(),n=e("#file-upload-preview-template").html();i.find("input[type=file]").each(function(){var t=e(this),a=t.closest(".form-group"),i=JSON.parse(a.find("script[data-upload-params]").html()),p=!!t.attr("multiple"),d=!!t.data("required");t.data("multiple",p),"image"==i.type?t.fileupload({url:"/image/upload",paramName:"img",formData:{resize:i.resize},beforeSend:function(){p||a.find("figure.image-upload-preview").remove(),a.append(r)},done:function(t,i){var r=a.find("figure.image-upload-preview.show-preloader").eq(0);r.removeClass("show-preloader"),r.css("background-image","url("+i.result.path+")"),r.find(".delete").show(),r.data("path",i.result.path),d&&e(this).removeAttr("required")}}):"file"==i.type&&t.fileupload({url:"/file/upload",paramName:"file",beforeSend:function(){p||a.find(".file-upload-preview").remove(),a.append(n)},done:function(t,i){a.find(".file-upload-preview.show-preloader").eq(0).removeClass("show-preloader").addClass(i.result.type).data("path",i.result.src).data("file-type",i.result.type).find(".title").text(i.result.original_name),d&&e(this).removeAttr("required")}})}),i.on("click","figure.image-upload-preview .delete",function(){var t=e(this).closest(".form-group"),a=t.find("input[type=file]"),i=a.data("required"),r=e(this).closest("figure"),n=r.data("path");e.ajax({url:"/admin/image/remove",type:"post",data:{path:n},success:function(){r.fadeOut(450,function(){r.remove(),i&&0==t.find("figure.image-upload-preview").length&&a.attr("required","required")})}})}),i.on("click",".file-upload-preview .delete",function(){var t=e(this).closest(".form-group"),a=t.find("input[type=file]"),i=a.data("required"),r=e(this).closest(".file-upload-preview"),n=r.data("path");e.ajax({url:"/file/delete",type:"post",data:{path:n},success:function(){r.fadeOut(450,function(){r.remove(),i&&0==t.find("figure.image-upload-preview").length&&a.attr("required","required")})}})}),CKFinder.setupCKEditor(null,"/ckfinder/"),i.find("textarea[data-ckeditor]").each(function(){var t=e(this).attr("id");CKEDITOR.replace(t,{extraPlugins:"justify"})}),i.submit(function(i){i.preventDefault();var r=e(this);r.find("textarea[data-ckeditor]").each(function(){var t=e(this).attr("id");CKEDITOR.instances[t].updateElement()});var n=r.serialize()+"&"+a();e.ajax({url:t.url,type:"post",data:n,beforeSend:function(){r.find("button[type=submit] .fa").show()},complete:function(){r.find("button[type=submit] .fa").hide()},success:function(e){e.is_new=e.is_new||!1;var a=e.is_new?t.afterAdd:t.afterUpdate;a&&a()},error:function(e){var t=404==e.status?"Error 404: URL not found":e.responseText;alertMessage(t,"error")}})})}}}(jQuery);