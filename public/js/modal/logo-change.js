define(["jquery","tplModalClose","fileupload","fancybox","jcrop"],function(e,a){function n(e){f.val(e.x),p.val(e.y),s.val(e.x2),c.val(e.y2),u.val(e.w),v.val(e.h)}function o(){r.addClass("hidden"),h.addClass("hidden"),i&&i.destroy(),l.removeAttr("src style");var a=m.val();a&&e.post("/upload/remove",{path:a}),e.each([f,p,s,c,u,v,m],function(e,a){a.val("")})}var i,t=e(".modal#logo-change-modal"),l=t.find("#logo-change-preview"),d=t.find(".size-tip"),h=l.parent(),r=t.find(".buttons");e("input#logo-change").fileupload({url:"/upload/photo",paramName:"photo",change:o,done:function(a,t){var f=t.result.path;l.attr("src",f).one("load",function(){h.removeClass("hidden"),r.removeClass("hidden"),e.fancybox.update();var a=e(this),t=a.width(),l=a.height();if(t<200||l<200)return d.addClass("-fail shake"),o();d.removeClass("-fail shake").hide();var f=t<l?t:l,p=t/2-(f-=.1*f)/2,s=l/2-f/2,c=[p,s,p+f,s+f];a.Jcrop({aspectRatio:1,minSize:[200,200],setSelect:c,boxWidth:500,boxHeight:500,bgColor:"#ccc",onSelect:n},function(){i=this})}),m.val(f)}}),e(".open-logo-change-modal").fancybox({padding:0,href:"#logo-change-modal",fitToView:!1,helpers:{overlay:{locked:!1}},tpl:{closeBtn:a},beforeShow:function(){d.show()},afterClose:o});var f=t.find("input[name=x]"),p=t.find("input[name=y]"),s=t.find("input[name=x2]"),c=t.find("input[name=y2]"),u=t.find("input[name=w]"),v=t.find("input[name=h]"),m=t.find("input[name=path]")});