define(["jquery","tplModalClose","fileupload","fancybox","jcrop"],function(e,a){function n(e){f.val(e.x),h.val(e.y),v.val(e.x2),u.val(e.y2),m.val(e.w),y.val(e.h)}function o(){c.addClass("hidden"),r.addClass("hidden"),i&&i.destroy(),d.removeAttr("src style");var a=g.val();a&&e.post("/upload/remove",{path:a}),e.each([f,h,v,u,m,y,g],function(e,a){a.val("")})}var i,t=e(".modal#cover-change-modal"),d=t.find("#cover-change-preview"),l=t.find(".size-tip"),r=d.parent(),c=t.find(".buttons"),p=e(".company-page-cover").data("aspect-ratio"),s=970/p;e("input#cover-change").fileupload({url:"/upload/photo",paramName:"photo",change:o,done:function(a,t){var f=t.result.path;d.attr("src",f).one("load",function(){r.removeClass("hidden"),c.removeClass("hidden"),e.fancybox.update();var a=e(this),t=a.width(),d=a.height(),f=t/d;if(t<970||d<s)return l.addClass("-fail shake"),o();if(l.removeClass("-fail shake").hide(),f<p)var h=t,v=t/p;else f>p&&(v=d,h=d*p);var u=t/2-h/2,m=d/2-v/2,y=[u,m,u+h,m+v];a.Jcrop({aspectRatio:p,minSize:[970,s],setSelect:y,boxWidth:750,boxHeight:500,bgColor:"#ccc",onSelect:n},function(){i=this})}),g.val(f)}}),e(".open-cover-change-modal").fancybox({padding:0,href:"#cover-change-modal",fitToView:!1,helpers:{overlay:{locked:!1}},tpl:{closeBtn:a},beforeShow:function(){l.show()},afterClose:o});var f=t.find("input[name=x]"),h=t.find("input[name=y]"),v=t.find("input[name=x2]"),u=t.find("input[name=y2]"),m=t.find("input[name=w]"),y=t.find("input[name=h]"),g=t.find("input[name=path]")});