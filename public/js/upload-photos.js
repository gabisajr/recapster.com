require(["/js/common.js"],function(){require(["jquery","async","fileupload","jquery-ui"],function(t,e){function i(e){var i=e.find(".preview"),o=e.find("img.preview-image"),n=e.find("input.path"),a=e.find(".original-name");e.find('input[type="file"][name="photo"]').fileupload({url:"/upload/photo",add:function(t,i){e.find(".btn-remove").click(function(){i.abort()}),i.submit()},change:function(e,i){var n=t(this).closest(".upload-photos-row");if(n.find(".btn-file, .three-dots").hide(),n.find(".preview, .fields, .btn-remove").show(),n.find("input.title").prop("required",!0),i.files&&i.files.length&&(a.text(i.files[0].name),FileReader)){var l=new FileReader;l.onload=function(){o.attr("src",l.result)},l.readAsDataURL(i.files[0])}},done:function(e,o){i.find(".preloader").remove(),n.val(o.result.path),t(e.target.form).find(".btn-submit:disabled").prop("disabled",!1)}}),e.find("input.location").focusout(function(){var e=t(this),i=e.closest(".upload-photos-row").find(".fields"),o=e.data("target")||"city",n=i.find('input[name="'+o+'"]'),a=n.data("for-title");e.val(e.val().trim()),a!=e.val()&&n.val("").data("for-title",null)}).autocomplete({source:function(e,i){t.ajax({type:"POST",dataType:"json",url:"/autocomplete/city",data:{filter:e.term},success:function(e){i(t.map(e,function(t){return{label:t.title,id:t.id}}))}})},select:function(e,i){var o=t(this),n=o.closest(".upload-photos-row").find(".fields"),a=o.data("target")||"city",l=n.find('input[name="'+a+'"]');l.length||(l=t('<input type="hidden" name="'+a+'">').appendTo(n)),l.val(i.item.id),setTimeout(function(){l.data("for-title",o.val())},0)},minLength:1}).autocomplete("instance")._renderItem=function(e,i){var o='<i class="icon map-marker"></i><div class="data"><div class="location-title">'+i.label+"</div></div>";return t('<li class="ac-location-item">').append(o).appendTo(e)}}var o;t(".upload-photos").on("add-row",function(){var n=t(this).find("table.upload-photos-table tbody");e.waterfall([function(e){if(o)return e();t.get("/tmpl/partials/upload-photos-row",function(t){o=t,e()})}],function(){var e=t(o),a=n.find(".upload-photos-row:last-child").data("index")+1;e.data("index",a).find(".photo-index-caption").text("Фото "+a),i(e),n.append(e)})}).on("click",".btn-add-row",function(e){e.preventDefault&&e.preventDefault(),t(this).closest(".upload-photos").trigger("add-row")}).on("click",".btn-remove",function(e){t(this).closest(".upload-photos-row").remove();var i=0;t(e.delegateTarget).find("input.path").each(function(){t(this).val()&&i++}),i||t(e.delegateTarget).closest("form").find(".btn-submit").prop("disabled",!0)}),t(".upload-photos .upload-photos-row").each(function(){i(t(this))})})});