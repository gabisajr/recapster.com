define(["jquery","caretEnd","autosize","i18n","jquery-ui","Modernizr","fileupload"],function(e,t,i,n){return function(a,o,d){if(a.length){o=o||{};var r=a.find('[type="submit"]'),u=a.find(':input[name="text"]'),l=a.find(".images-container"),f=a.find(".fileupload"),p=a.find(".add-image"),s=a.find("#tmpl-upload-item").html().trim(),m=!1;i(u),u.focus(t),o.autofocus&&u.focus(),l.sortable({start:function(e,t){t.item.removeClass("zoom-in")}}),f.fileupload({url:"/upload/photo",paramName:"photo",add:function(t,i){if(!i.files||!i.files.length)return!1;if(10==l.find(".upload-item").length)return!1;var n=i.files[0],a=e(s).uniqueId(),o=a.find("img.preview");Modernizr.filereader?function(e){var t=new FileReader;t.onload=function(){e.attr("src",t.result)},t.readAsDataURL(n)}(o):o.hide(),a.addClass("zoom-in").appendTo(l),i.formData={id:a.attr("id")},i.submit(),r.prop("disabled",!0),10==l.find(".upload-item").length&&p.hide()},done:function(t,i){var n=l.find(".upload-item#"+i.formData.id);n.data("path",i.result.path),n.find(".panel-loader").fadeOut(function(){e(this).remove()}),n.find(".delete").show(),Modernizr.filereader||n.find("img.preview").attr("src",i.result.path).fadeIn(150)},stop:function(){r.prop("disabled",!1)}}),a.on("click",".upload-item .delete",function(t){if(t.preventDefault(),t.stopPropagation(),m)return!1;var i=e(this).closest(".upload-item").addClass("zoom-out");setTimeout(function(){i.remove(),p.show()},300);var n=i.data("path");n&&e.post("/upload/remove",{path:n}),l.find(".upload-item-preview").length||r.prop("disabled",!0)}),a.submit(function(t){t.preventDefault();var i=a.serializeArray();l.find(".upload-item").each(function(){e.each(e(this).data(),function(e,t){i.push({name:"photo["+e+"][]",value:t})})}),e.ajax({url:a.attr("action"),type:a.attr("method"),data:i,beforeSend:function(){a.find("input[type=file]").prop("disabled",!0),r.prop("disabled",!0),m=!0},complete:function(){a.find("input[type=file]").prop("disabled",!1),r.prop("disabled",!1),m=!1},success:function(e){return l.html(""),d(e)}})}),window.onbeforeunload=function(e){if(l.is(":visible")&&l.find(".upload-item").length){e=e||window.event;var t=n("Вы уверены?");return e&&(e.returnValue=t),t}}}}});